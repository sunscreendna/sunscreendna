<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Sunscreen Details ‚Äì Sunscreen DNA</title>
  <link rel="stylesheet" href="global.css">
</head>

<body>

  <!-- ============================= -->
  <!-- GLOBAL SITE HEADER -->
  <!-- ============================= -->
  <header class="site-header">
    <div class="header-inner">
      <a href="index.html">
        <img
          src="images/sunscreen-dna-logo-cropped.png"
          alt="Sunscreen DNA"
          class="site-logo"
        >
      </a>

      <nav class="site-nav">
        <a href="all.html">All Sunscreens</a>

        <div class="dropdown">
          <span class="dropdown-btn">About ‚ñæ</span>
          <div class="dropdown-content">
            <a href="about.html">Methodology</a>
            <a href="filters.html">UV Filters</a>
          </div>
        </div>

        <div class="cta-wrapper">
          <a href="submit.html" class="menu-link-primary">Add a Sunscreen</a>
          <span class="cta-note">Community-reviewed</span>
        </div>
      </nav>

      <button class="nav-toggle" aria-label="Menu">‚ò∞</button>
    </div>
  </header>

  <!-- ============================= -->
  <!-- PAGE CONTENT -->
  <!-- ============================= -->
  <main class="sunscreen-page">

    <p class="back-link">
      <a href="all.html">‚Üê Back to All Sunscreens</a>
    </p>

    <h1 id="title">Loading‚Ä¶</h1>

    <div id="details"></div>

  </main>

  <script>
    async function loadSunscreens() {
      const response = await fetch("data/sunscreens.json");
      return response.json();
    }

    function getIdFromUrl() {
      const params = new URLSearchParams(window.location.search);
      return params.get("id");
    }

    function formatIngredientLink(ing) {
      const urlSlug = ing
        .toLowerCase()
        .replace(/[^a-z0-9 ]/g, "")
        .replace(/\s+/g, "-");

      return `<a href="https://incidecoder.com/ingredients/${urlSlug}" target="_blank" rel="noopener">${ing}</a>`;
    }

    loadSunscreens().then(all => {
      const id = getIdFromUrl();
      const item = all.find(s => String(s.id) === String(id));

      if (!item) {
        document.getElementById("title").innerText = "Sunscreen Not Found";
        return;
      }

      const spfText = item.spf ? ` SPF ${item.spf}` : "";

      document.getElementById("title").innerText =
        `${item.brand ?? ""} ${item.product ?? ""}${spfText}`.trim();

      const filterList = item.filters?.length
        ? `<ul class="filter-list">
            ${item.filters.map(f => `<li>${f.name}</li>`).join("")}
          </ul>`
        : "<p>No UV filters listed.</p>";

      const html = `
        <article class="sunscreen-card">

          <section class="meta-grid">
            <div><strong>Type</strong><span>${item.type ?? "Unknown"}</span></div>
            <div><strong>SPF</strong><span>${item.spf ?? "Unknown"}</span></div>
            <div><strong>PA</strong><span>${item.pa ?? "Not stated"}</span></div>
          </section>

          <section class="section">
            <h2>UV Filter System</h2>
            ${filterList}
          </section>

          ${item.notes ? `
            <section class="section notes">
              <h2>Notes</h2>
              <p>${item.notes}</p>
            </section>
          ` : ""}

          <p class="report-wrapper">
            <a class="report-link"
               href="#"
               onclick="submitSunscreenIssue(
                 '${item.id}',
                 '${(item.brand ?? "").replace(/'/g, "\\'")}',
                 '${(item.product ?? "").replace(/'/g, "\\'")}'
               ); return false;">
              üì£ Report an Issue with This Entry
            </a>
          </p>

        </article>
      `;

      document.getElementById("details").innerHTML = html;
    });

    async function submitSunscreenIssue(id, brand, product) {
      const payload = {
        title: `Issue with sunscreen: ${brand} ${product}`,
        body: `
A user reported a problem with this sunscreen entry.

**ID:** ${id}
**Brand:** ${brand}
**Product:** ${product}
**URL:** ${window.location.href}
        `.trim(),
        labels: ["sunscreen-issue"]
      };

      try {
        const response = await fetch("/.netlify/functions/createIssue", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (response.ok) {
          alert("Thanks! Your report has been submitted.");
        } else {
          alert("There was a problem submitting the report.");
        }
      } catch (err) {
        alert("Network error while submitting report.");
      }
    }
  </script>

</body>
</html>
